{{- /* 文章内搜索功能 */ -}}
<div class="content-search">
    <details>
        <summary>文内查找</summary>
        <div class="inner">
            <div class="search-container">
                <input type="text" id="contentSearchInput" placeholder="输入关键词搜索...">
            </div>
            
            <div id="searchResultsSummary"></div>
            
            <div id="searchNavigation">
                <button id="prevMatchButton" disabled>
                    上一个
                </button>
                <span id="matchCounter"></span>
                <button id="nextMatchButton" disabled>
                    下一个
                </button>
                <button id="clearSearchButton">
                    清除
                </button>
            </div>
        </div>
    </details>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('contentSearchInput');
        const prevMatchButton = document.getElementById('prevMatchButton');
        const nextMatchButton = document.getElementById('nextMatchButton');
        const clearSearchButton = document.getElementById('clearSearchButton');
        const searchResultsSummary = document.getElementById('searchResultsSummary');
        const matchCounter = document.getElementById('matchCounter');
        
        let searchMatches = [];
        let currentMatchIndex = -1;
        let searchTerm = '';
        
        // 添加搜索功能
        function performSearch() {
            // 清除之前的高亮
            clearHighlights();
            
            searchTerm = searchInput.value.trim();
            if (!searchTerm) {
                searchResultsSummary.textContent = '';
                matchCounter.textContent = '';
                prevMatchButton.disabled = true;
                nextMatchButton.disabled = true;
                // 样式由CSS文件控制
                return;
            }
            
            const contentElement = document.querySelector('.post-content');
            if (!contentElement) return;
            
            // 保存原始内容以便恢复
            if (!contentElement.dataset.originalContent) {
                contentElement.dataset.originalContent = contentElement.innerHTML;
            }
            
            // 获取文本内容
            let content = contentElement.dataset.originalContent;
            
            // 转义正则表达式特殊字符
            const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            
            // 创建正则表达式，不区分大小写
            const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
            
            // 查找所有匹配项
            searchMatches = [];
            let match;
            let lastIndex = 0;
            let highlightedContent = '';
            
            while ((match = regex.exec(content)) !== null) {
                // 确保不会无限循环
                if (match.index === regex.lastIndex) {
                    regex.lastIndex++;
                }
                
                // 添加匹配项信息
                searchMatches.push({
                    term: match[0],
                    index: match.index
                });
            }
            
            // 高亮匹配项
            if (searchMatches.length > 0) {
                highlightedContent = content.replace(regex, '<mark class="search-highlight" style="background-color: rgba(255, 255, 0, 0.5); border-radius: 2px;">$1</mark>');
                contentElement.innerHTML = highlightedContent;
                
                // 更新搜索结果摘要
                searchResultsSummary.textContent = `找到 ${searchMatches.length} 个匹配项`;
                
                // 初始化当前匹配项为第一个
                currentMatchIndex = 0;
                updateMatchNavigation();
                scrollToMatch(currentMatchIndex);
            } else {
                searchResultsSummary.textContent = '未找到匹配项';
                matchCounter.textContent = '';
                prevMatchButton.disabled = true;
                nextMatchButton.disabled = true;
                // 样式由CSS文件控制
            }
        }
        
        // 清除高亮
        function clearHighlights() {
            const contentElement = document.querySelector('.post-content');
            if (contentElement && contentElement.dataset.originalContent) {
                contentElement.innerHTML = contentElement.dataset.originalContent;
            }
            searchMatches = [];
            currentMatchIndex = -1;
        }
        
        // 更新匹配项导航
        function updateMatchNavigation() {
            if (searchMatches.length > 0) {
                matchCounter.textContent = `${currentMatchIndex + 1} / ${searchMatches.length}`;
                prevMatchButton.disabled = currentMatchIndex <= 0;
                nextMatchButton.disabled = currentMatchIndex >= searchMatches.length - 1;
                
                // 样式由CSS文件控制
            }
        }
        
        // 滚动到指定匹配项
        function scrollToMatch(index) {
            const highlights = document.querySelectorAll('.search-highlight');
            if (highlights && highlights[index]) {
                // 添加闪烁效果以突出显示
                const highlight = highlights[index];
                highlight.style.animation = 'none';
                highlight.offsetHeight; // 触发重绘
                highlight.style.animation = 'searchHighlightBlink 1s ease-in-out';
                
                // 滚动到视图
                highlight.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
            }
        }
        
        // 上一个匹配项
        function goToPrevMatch() {
            if (searchMatches.length > 0 && currentMatchIndex > 0) {
                currentMatchIndex--;
                updateMatchNavigation();
                scrollToMatch(currentMatchIndex);
            }
        }
        
        // 下一个匹配项
        function goToNextMatch() {
            if (searchMatches.length > 0 && currentMatchIndex < searchMatches.length - 1) {
                currentMatchIndex++;
                updateMatchNavigation();
                scrollToMatch(currentMatchIndex);
            }
        }
        
        // 清除搜索
        function clearSearch() {
            searchInput.value = '';
            clearHighlights();
            searchResultsSummary.textContent = '';
            matchCounter.textContent = '';
            prevMatchButton.disabled = true;
            nextMatchButton.disabled = true;
            prevMatchButton.style.cursor = 'not-allowed';
            nextMatchButton.style.cursor = 'not-allowed';
            prevMatchButton.style.color = 'var(--secondary)';
            nextMatchButton.style.color = 'var(--secondary)';
        }
        
        // 添加事件监听器
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        prevMatchButton.addEventListener('click', goToPrevMatch);
        nextMatchButton.addEventListener('click', goToNextMatch);
        clearSearchButton.addEventListener('click', clearSearch);
        
        // 添加键盘快捷键
        document.addEventListener('keydown', function(e) {
            // Alt+F 聚焦搜索框
            if (e.altKey && e.key === 'f') {
                e.preventDefault();
                searchInput.focus();
            }
            // F3 或 Ctrl+G 下一个匹配项
            if ((e.key === 'F3' || (e.ctrlKey && e.key === 'g')) && !e.shiftKey) {
                e.preventDefault();
                if (searchMatches.length > 0) {
                    goToNextMatch();
                }
            }
            // Shift+F3 或 Ctrl+Shift+G 上一个匹配项
            if ((e.key === 'F3' && e.shiftKey) || (e.ctrlKey && e.shiftKey && e.key === 'g')) {
                e.preventDefault();
                if (searchMatches.length > 0) {
                    goToPrevMatch();
                }
            }
        });
        
        // 闪烁动画样式已在CSS文件中定义
    });
</script>